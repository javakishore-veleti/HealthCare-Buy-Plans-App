name: GCP Deploy - UI - Angular Frontend

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select deployment environment'
        required: true
        type: choice
        options:
          - dev-server
          - qa-server
          - pre-prod-server
          - prod-server

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-south1
  SERVICE_NAME: healthcare-plans-ui

jobs:
  build-and-deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      # -----------------------------------------
      # Step 1: Checkout code
      # -----------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------
      # Step 2: Set environment-specific variables
      # -----------------------------------------
      - name: Set environment variables
        id: env-config
        run: |
          case "${{ github.event.inputs.environment }}" in
            dev-server)
              echo "INSTANCE_SUFFIX=dev" >> $GITHUB_OUTPUT
              echo "MIN_INSTANCES=0" >> $GITHUB_OUTPUT
              echo "MAX_INSTANCES=2" >> $GITHUB_OUTPUT
              ;;
            qa-server)
              echo "INSTANCE_SUFFIX=qa" >> $GITHUB_OUTPUT
              echo "MIN_INSTANCES=0" >> $GITHUB_OUTPUT
              echo "MAX_INSTANCES=3" >> $GITHUB_OUTPUT
              ;;
            pre-prod-server)
              echo "INSTANCE_SUFFIX=preprod" >> $GITHUB_OUTPUT
              echo "MIN_INSTANCES=1" >> $GITHUB_OUTPUT
              echo "MAX_INSTANCES=5" >> $GITHUB_OUTPUT
              ;;
            prod-server)
              echo "INSTANCE_SUFFIX=prod" >> $GITHUB_OUTPUT
              echo "MIN_INSTANCES=2" >> $GITHUB_OUTPUT
              echo "MAX_INSTANCES=10" >> $GITHUB_OUTPUT
              ;;
          esac

      # -----------------------------------------
      # Step 3: Authenticate to Google Cloud
      # -----------------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # -----------------------------------------
      # Step 4: Set up Cloud SDK
      # -----------------------------------------
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # -----------------------------------------
      # Step 5: Get Django API URL from Cloud Run
      # -----------------------------------------
      - name: Get Django API URL
        id: get-api-url
        run: |
          echo "Fetching Django API URL for environment: ${{ steps.env-config.outputs.INSTANCE_SUFFIX }}"
          
          API_URL=$(gcloud run services describe healthcare-plans-api-${{ steps.env-config.outputs.INSTANCE_SUFFIX }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' 2>/dev/null || echo "")
          
          if [ -z "$API_URL" ]; then
            echo "::error::Django API service 'healthcare-plans-api-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}' not found!"
            echo "::error::Please deploy Django backend first using 'GCP Deploy - API - Django Backend' workflow."
            exit 1
          fi
          
          echo "API_URL=$API_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Found Django API URL: $API_URL"

      # -----------------------------------------
      # Step 6: Setup Node.js
      # -----------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front_end_code/healthcare_plans_ui/package-lock.json

      # -----------------------------------------
      # Step 7: Install dependencies
      # -----------------------------------------
      - name: Install dependencies
        working-directory: front_end_code/healthcare_plans_ui
        run: npm ci

      # -----------------------------------------
      # Step 8: Update environment file with API URL
      # -----------------------------------------
      - name: Update environment configuration
        working-directory: front_end_code/healthcare_plans_ui
        run: |
          echo "Updating environment.ts with API URL: ${{ steps.get-api-url.outputs.API_URL }}"
          
          cat > src/environments/environment.ts << EOF
          export const environment = {
            production: ${{ github.event.inputs.environment == 'prod-server' }},
            apiBaseUrl: '${{ steps.get-api-url.outputs.API_URL }}/api/v1',
            appName: 'Your Health Plans',
            environment: '${{ github.event.inputs.environment }}'
          };
          EOF
          
          echo "‚úÖ Updated environment.ts:"
          cat src/environments/environment.ts

      # -----------------------------------------
      # Step 9: Build Angular app
      # -----------------------------------------
      - name: Build Angular app
        working-directory: front_end_code/healthcare_plans_ui
        run: npm run build

      # -----------------------------------------
      # Step 10: Configure Docker for GCP
      # -----------------------------------------
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # -----------------------------------------
      # Step 11: Create Dockerfile for nginx
      # -----------------------------------------
      - name: Create Dockerfile
        working-directory: front_end_code/healthcare_plans_ui
        run: |
          cat > Dockerfile << 'EOF'
          FROM nginx:alpine
          
          # Copy built Angular app
          COPY dist/healthcare_plans_ui/browser /usr/share/nginx/html
          
          # Copy nginx configuration
          COPY nginx.conf /etc/nginx/conf.d/default.conf
          
          # Expose port 8080 (Cloud Run requirement)
          EXPOSE 8080
          
          CMD ["nginx", "-g", "daemon off;"]
          EOF
          
          cat > nginx.conf << 'EOF'
          server {
              listen 8080;
              server_name localhost;
              root /usr/share/nginx/html;
              index index.html;
              
              # Gzip compression
              gzip on;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;
              
              # Handle Angular routes
              location / {
                  try_files $uri $uri/ /index.html;
              }
              
              # Cache static assets
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
          }
          EOF

      # -----------------------------------------
      # Step 12: Build Docker image
      # -----------------------------------------
      - name: Build Docker image
        working-directory: front_end_code/healthcare_plans_ui
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/healthcare-plans/${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}:${{ github.sha }} .
          docker tag ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/healthcare-plans/${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}:${{ github.sha }} ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/healthcare-plans/${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}:latest

      # -----------------------------------------
      # Step 13: Push Docker image
      # -----------------------------------------
      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/healthcare-plans/${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/healthcare-plans/${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}:latest

      # -----------------------------------------
      # Step 14: Deploy to Cloud Run
      # -----------------------------------------
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/healthcare-plans/${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --memory 256Mi \
            --cpu 1 \
            --min-instances ${{ steps.env-config.outputs.MIN_INSTANCES }} \
            --max-instances ${{ steps.env-config.outputs.MAX_INSTANCES }} \
            --allow-unauthenticated \
            --set-env-vars "ENVIRONMENT=${{ github.event.inputs.environment }}" \
            --format 'value(status.url)'
          
          echo "url=$(gcloud run services describe ${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }} --region ${{ env.REGION }} --format 'value(status.url)')" >> $GITHUB_OUTPUT

      # -----------------------------------------
      # Step 15: Deployment summary
      # -----------------------------------------
      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "‚úÖ Angular Frontend Deployment Complete!"
          echo "=========================================="
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Service: ${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}"
          echo ""
          echo "üåê Frontend URL: ${{ steps.deploy.outputs.url }}"
          echo "üîó Backend API URL: ${{ steps.get-api-url.outputs.API_URL }}/api/v1"
          echo ""
          echo "Image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/healthcare-plans/${{ env.SERVICE_NAME }}-${{ steps.env-config.outputs.INSTANCE_SUFFIX }}:${{ github.sha }}"
          echo ""
          echo "=========================================="
